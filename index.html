<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>三高智慧導航 - 整合儀表板</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <style>
        .patient-btn { transition: 0.3s; cursor: pointer; border: 2px solid transparent; }
        .patient-btn:hover { border-color: #007bff; background: #e9ecef; }
        .patient-btn.active { border-color: #007bff; background: #007bff; color: white !important; }
        .card-red { border-left: 6px solid #dc3545 !important; }
        .card-yellow { border-left: 6px solid #ffc107 !important; }
        .card-green { border-left: 6px solid #28a745 !important; }
        .metric-val { font-size: 2rem; font-weight: bold; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; display: none; }
    </style>
</head>
<body class="bg-light">

<div id="loader">
    <div class="spinner-border text-primary mr-3"></div> 正在讀取 FHIR 臨床資源...
</div>

<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body bg-white rounded">
                    <h5 class="font-weight-bold mb-3"><i class="fas fa-users-cog mr-2"></i> 模擬診間：請選擇今日看診對象</h5>
                    <div class="d-flex justify-content-between">
                        <div class="patient-btn p-2 rounded text-center flex-fill mx-1" onclick="switchPatient('690715', this)">
                            <div class="font-weight-bold">Jason Lin (A)</div>
                            <small>肥胖管理</small>
                        </div>
                        <div class="patient-btn p-2 rounded text-center flex-fill mx-1" onclick="switchPatient('690718', this)">
                            <div class="font-weight-bold">Jason Lin (B)</div>
                            <small>糖尿病前期</small>
                        </div>
                        <div class="patient-btn p-2 rounded text-center flex-fill mx-1" onclick="switchPatient('690720', this) ">
                            <div class="font-weight-bold">Jason Chen (C)</div>
                            <small>高血脂風險</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="main-ui" style="display:none;">
        <div class="card shadow-sm border-0 mb-4 bg-primary text-white">
            <div class="card-body d-flex justify-content-between align-items-center py-3">
                <div>
                    <h2 id="p-name" class="mb-0 font-weight-bold">讀取中...</h2>
                    <span id="p-id" class="badge badge-light mt-1">ID: --</span>
                </div>
                <i class="fas fa-stethoscope fa-3x"></i>
            </div>
        </div>

        <div id="scene-box" class="alert shadow-sm mb-4" style="display:none; border-radius: 10px;">
            <h4 class="font-weight-bold"><i id="scene-icon" class="fas mr-2"></i> <span id="scene-title"></span></h4>
            <p id="scene-msg" class="mb-0"></p>
        </div>

        <div class="row mb-4">
            <div class="col-md-4 mb-2"><div id="card-bmi" class="card shadow-sm text-center py-3"><div class="text-muted small">BMI</div><div id="val-bmi" class="metric-val">--</div></div></div>
            <div class="col-md-4 mb-2"><div id="card-hba1c" class="card shadow-sm text-center py-3"><div class="text-muted small">HbA1c</div><div id="val-hba1c" class="metric-val">--</div></div></div>
            <div class="col-md-4 mb-2"><div id="card-ldl" class="card shadow-sm text-center py-3"><div class="text-muted small">LDL</div><div id="val-ldl" class="metric-val">--</div></div></div>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-header bg-white font-weight-bold text-primary">關聯資源 (TW Core Profile)</div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <tbody id="res-list"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="welcome-msg" class="text-center py-5 text-muted">
        <i class="fas fa-arrow-up fa-3x mb-3"></i>
        <h3>請從上方清單選擇病患開始 Demo</h3>
    </div>
</div>

<script>
    let fhirClient = null;

    // 1. 初始化 SMART on FHIR
    FHIR.oauth2.ready().then(client => {
        fhirClient = client;
        // 如果網址已經有指定病人，可以直接讀取
        if (client.patient.id) {
            loadPatientData(client.patient.id);
        }
    }).catch(console.error);

    // 2. 切換病人邏輯 (用於合併頁面切換)
    function switchPatient(id, btn) {
        // 更新 UI 狀態
        document.querySelectorAll('.patient-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        loadPatientData(id);
    }

    // 3. 讀取與渲染數據
    function loadPatientData(id) {
        document.getElementById('loader').style.display = 'flex';
        document.getElementById('welcome-msg').style.display = 'none';
        document.getElementById('main-ui').style.display = 'block';

        // 重置 UI
        resetUI();

        // 模擬切換 context 抓取特定病患
        const q = `patient=${id}`;
        Promise.all([
            fhirClient.request(`Patient/${id}`),
            fhirClient.request(`Observation?${q}`),
            fhirClient.request(`Condition?${q}`),
            fhirClient.request(`ServiceRequest?${q}`)
        ]).then(([p, obs, cond, srv]) => {
            document.getElementById('loader').style.display = 'none';
            
            // 患者基本資訊
            document.getElementById('p-name').innerText = p.name ? p.name[0].text : "未知患者";
            document.getElementById('p-id').innerText = `Patient ID: ${p.id}`;

            const obsArr = obs.entry ? obs.entry.map(e => e.resource) : [];
            const condArr = cond.entry ? cond.entry.map(e => e.resource) : [];
            const srvArr = srv.entry ? srv.entry.map(e => e.resource) : [];

            // 數據識別
            const bmi = getVal(obsArr, '39156-5'), hba1c = getVal(obsArr, '4548-4'), ldl = getVal(obsArr, '13457-7');
            if (bmi) updateMetric('bmi', bmi, 27, 24, "kg/m²");
            if (hba1c) updateMetric('hba1c', hba1c, 6.5, 5.7, "%");
            if (ldl) updateMetric('ldl', ldl, 130, 100, "mg/dL");

            // 場景識別 (核心分流邏輯)
            const sceneBox = document.getElementById('scene-box');
            if (bmi >= 27 || condArr.some(c => c.code?.coding?.some(d => d.code === 'E66.9'))) {
                showScene("肥胖管理場景 (Jason A)", "檢出 BMI 指標及肥胖診斷，系統已自動關聯健保營養管理計畫。", "alert-danger", "fa-weight");
            } else if (hba1c >= 5.7) {
                showScene("糖尿病前期預警 (Jason B)", "HbA1c 數據落於風險區，建議啟動居家血糖監測與飲食衛教。", "alert-warning", "fa-exclamation-triangle");
            } else if (ldl > 130) {
                showScene("血脂風險管理 (Jason C)", "低密度膽固醇超標。系統建議定期追蹤血脂報告，預防心血管疾病。", "alert-info", "fa-heartbeat");
            }

            // 列表渲染
            const list = document.getElementById('res-list');
            condArr.forEach(c => list.innerHTML += `<tr><td><span class="badge badge-danger">診斷</span></td><td>${c.code.coding[0].display}</td></tr>`);
            srvArr.forEach(s => list.innerHTML += `<tr><td><span class="badge badge-primary">醫囑</span></td><td>${s.code.text || s.code.coding[0].display}</td></tr>`);
        });
    }

    function getVal(list, code) {