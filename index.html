<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>三高智慧照護導航 App</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <style>
        .card-red { border-left: 5px solid #e74a3b !important; }
        .card-yellow { border-left: 5px solid #f6c23e !important; }
        .card-green { border-left: 5px solid #1cc88a !important; }
        .card-inactive { opacity: 0.5; border-left: 5px solid #dee2e6 !important; }
        .loading { display: flex; justify-content: center; align-items: center; height: 100vh; font-size: 1.5rem; }
        .metric-value { font-size: 1.8rem; }
    </style>
</head>
<body class="bg-light">

    <div id="loader" class="loading">
        <div class="spinner-border text-primary mr-3"></div> 正在同步衛福部數據並進行分流判讀...
    </div>

    <div id="content" class="container py-4" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 text-gray-800">三高智慧照護導航</h1>
            <div id="patient-info" class="badge badge-primary p-2" style="font-size: 1rem;">載入中...</div>
        </div>

        <div id="scene-container" class="mb-4"></div>

        <div class="row">
            <div class="col-md-4 mb-4">
                <div id="card-bmi" class="card shadow h-100 py-2 card-inactive">
                    <div class="card-body">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">BMI (體重管理)</div>
                        <div id="val-bmi" class="metric-value font-weight-bold text-gray-800">無數據</div>
                        <small class="text-muted">LOINC: 39156-5</small>
                    </div>
                </div>
            </div>

            <div class="col-md-4 mb-4">
                <div id="card-hba1c" class="card shadow h-100 py-2 card-inactive">
                    <div class="card-body">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">HbA1c (糖化血色素)</div>
                        <div id="val-hba1c" class="metric-value font-weight-bold text-gray-800">無數據</div>
                        <small class="text-muted">LOINC: 4548-4</small>
                    </div>
                </div>
            </div>

            <div class="col-md-4 mb-4">
                <div id="card-ldl" class="card shadow h-100 py-2 card-inactive">
                    <div class="card-body">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">LDL (低密度脂蛋白)</div>
                        <div id="val-ldl" class="metric-value font-weight-bold text-gray-800">無數據</div>
                        <small class="text-muted">LOINC: 13457-7</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header font-weight-bold text-primary">臨床關聯資源 (TW Core Profile)</div>
            <div class="card-body p-0">
                <table class="table mb-0">
                    <thead class="bg-light">
                        <tr><th>類型</th><th>名稱 / 內容</th><th>代碼</th></tr>
                    </thead>
                    <tbody id="res-table-body"></tbody>
                </table>
            </div>
        </div>
        
        <button onclick="window.print()" class="btn btn-primary btn-block shadow-sm">
            <i class="fas fa-print mr-2"></i> 產出臨床決策建議報告
        </button>
    </div>

    <script>
        // 強健的數值抓取函數
        function getVal(obs